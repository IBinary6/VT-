From patchwork Thu Jan 24 11:16:27 2019
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Alexandru Elisei <alexandru.elisei@arm.com>
X-Patchwork-Id: 10778745
Return-Path: <kvm-owner@kernel.org>
Received: from mail.wl.linuxfoundation.org (pdx-wl-mail.web.codeaurora.org
 [172.30.200.125])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id 0E2FE13B5
	for <patchwork-kvm@patchwork.kernel.org>;
 Thu, 24 Jan 2019 11:17:02 +0000 (UTC)
Received: from mail.wl.linuxfoundation.org (localhost [127.0.0.1])
	by mail.wl.linuxfoundation.org (Postfix) with ESMTP id F23862EB51
	for <patchwork-kvm@patchwork.kernel.org>;
 Thu, 24 Jan 2019 11:17:01 +0000 (UTC)
Received: by mail.wl.linuxfoundation.org (Postfix, from userid 486)
	id E65192EBA4; Thu, 24 Jan 2019 11:17:01 +0000 (UTC)
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on
	pdx-wl-mail.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-7.9 required=2.0 tests=BAYES_00,MAILING_LIST_MULTI,
	RCVD_IN_DNSWL_HI autolearn=ham version=3.3.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by mail.wl.linuxfoundation.org (Postfix) with ESMTP id 787842EB51
	for <patchwork-kvm@patchwork.kernel.org>;
 Thu, 24 Jan 2019 11:17:01 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727556AbfAXLQ7 (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Thu, 24 Jan 2019 06:16:59 -0500
Received: from usa-sjc-mx-foss1.foss.arm.com ([217.140.101.70]:54752 "EHLO
        foss.arm.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1726014AbfAXLQ7 (ORCPT <rfc822;kvm@vger.kernel.org>);
        Thu, 24 Jan 2019 06:16:59 -0500
Received: from usa-sjc-imap-foss1.foss.arm.com (unknown [10.72.51.249])
        by usa-sjc-mx-foss1.foss.arm.com (Postfix) with ESMTP id EC9551596;
        Thu, 24 Jan 2019 03:16:58 -0800 (PST)
Received: from login12.euhpc.arm.com (login12.euhpc.arm.com [10.6.27.168])
        by usa-sjc-imap-foss1.foss.arm.com (Postfix) with ESMTPA id
 DBB8B3F237;
        Thu, 24 Jan 2019 03:16:57 -0800 (PST)
From: Alexandru Elisei <alexandru.elisei@arm.com>
To: kvm@vger.kernel.org
Cc: drjones@redhat.com, kvmarm@lists.cs.columbia.edu,
        andre.przywara@arm.com, vladimir.murzin@arm.com
Subject: [kvm-unit-tests PATCH 0/7] arm/arm64: Add support for running under
 kvmtool
Date: Thu, 24 Jan 2019 11:16:27 +0000
Message-Id: <20190124111634.4727-1-alexandru.elisei@arm.com>
X-Mailer: git-send-email 2.17.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org
X-Virus-Scanned: ClamAV using ClamSMTP

kvm-unit-tests is designed to be run with QEMU as the virtual machine
monitor. It relies on devices emulated by QEMU (like isa-debug-exit or
testdev) and it makes certain assumptions based on the implicit QEMU
virtual environment configuration (like the serial base address).

kvmtool [1] is a lightweight virtual machine monitor for running KVM
guests. kvmtool has reduced complexity compared to QEMU and is easily
hackable.

This patch series aims to make it possible to run kvm-unit-tests using
kvmtool on the arm and arm64 architectures, with one caveat: when
terminating a test, the userspace process won't exit with an exit code that
signals the success or failure of the test. Output from the test can still
be parsed to determine the outcome of the test.

* Patches 1 and 2 add support for discovering the ns16550a UART emulated by
  kvmtool on arm and arm64.
* Patches 3,4 and 5 provide an alternative mechanism for terminating the
  virtual machine by using PSCI.
* Patches 6 and 7 remove an error when parsing the test parameters
  generated by kvmtool.


[1] https://git.kernel.org/pub/scm/linux/kernel/git/will/kvmtool.git/

Alexandru Elisei (7):
  lib: arm: Discover ns16550a UART
  lib: arm: Remove warning about uart0_base mismatch
  lib: chr-testdev: Make chr_testdev_init() return status
  lib: arm: Implement PSCI SYSTEM_OFF in psci_system_off()
  lib: arm: Fallback to psci_system_off() in exit()
  lib: argv: Implement argv_find() for test parameters
  arm/arm64: Use argv_find() for test names

 lib/arm/asm/psci.h |  1 +
 lib/argv.h         |  1 +
 lib/chr-testdev.h  |  2 +-
 lib/argv.c         | 11 +++++++++++
 lib/arm/io.c       | 38 +++++++++++++++++++++++---------------
 lib/arm/psci.c     |  6 ++++++
 lib/chr-testdev.c  |  8 +++++---
 arm/gic.c          |  7 ++++---
 arm/selftest.c     | 19 ++++++++++++-------
 9 files changed, 64 insertions(+), 29 deletions(-)
